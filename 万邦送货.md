# 万邦送货
## 一、项目概述
"万邦送货"是基于万邦仓储系统的物流配送解决方案，采用单体架构设计，集成订单派送、司机接单、实时位置追踪等功能，实现从仓库到客户的全流程物流配送管理。该系统基于Spring Boot框架，通过模块化设计实现高效、稳定的物流配送平台。

### 1.1 项目背景
万邦仓储系统目前已实现瓷砖库存管理和订单处理功能，但缺乏完整的物流配送环节。"万邦送货"项目将提供订单派送、司机接单、实时位置追踪等功能，弥补现有系统的不足，提升客户体验和运营效率。同时对万邦仓储系统增加模块:派单模块、司机注册审核模块、订单派送状态模块、异常配送处理模块。

### 1.2 项目目标
1. 司机端第一次登录即注册，需提交姓名手机号，同时将信息发到管理端，在管理端审核通过之前，司机端不能进入小程序，显示“未审核”。
2. 小程序底栏一共三个模块：地图、订单、我的。
3. 地图模块：页面右上角有状态切换按钮（接单状态：在线，离线，离线不可接单，忙碌：接单后状态同时在接单时候隐藏切换状态按钮，取消或完成配送自动切换回在线）
	1. 司机当前的位置通过RedisGEO获得，每（5）秒更新一次传入redis
	2. 在上线后会受到派单信息（Rabbitmq）（Redisson分布式锁）：订单金额、客户名、货物重量、目标地址。现时1分钟抢单。
		1. 接受订单后，调用腾讯位置服务获取返回的第一条路线信息返回前端，（左上角显示距离与时间）下方显示订单信息：客户、电话、地址、货物重量、运费。
		2. 下方可以点击联系客户与完成配送，右方可以点击红色圈进行取消订单操作。
		3. 订单没有被接单一段时间（10分钟）后由xxl-job触发每五分钟再重新派单。
		4. 在管理端页面只需要点一次派单即可，前1分钟由mq进行抢单，1到10分钟可由司机在订单模块自己抢单，超过10分钟由xxl-job自动派单。
4. 订单模块：上左中右栏分别为：待接单、配送中、已完成。
	1. 待接单会显示订单号（与系统端的订单order_no相同）可以选择未接单的单子进行接单（Redisson分布式锁）
	2. 配送中可以选择取消订单和完成配送
	3. 已完成可以看到订单信息：客户、电话、地址、吨位、费用。
5. 我的页面：最上方有登录信息：头像姓名id，总单数和月收入。在下方有个人信息与钱包，最下方是退出登录按钮。
	1. 个人信息页面：头像，姓名，手机号。有提交信息按钮（修改信息）（修改后重新设置审核状态）
	2. 我的钱包：只显示用户余额（在系统端可以清零提现（手动））

## 二、系统架构设计
### 2.1 整体架构
采用Spring Boot单体应用架构，包含以下核心组件：
- Spring Boot：应用框架
- MyBatis Plus：ORM框架，简化数据库操作
- Redis：缓存和会话管理
- RabbitMQ：派单 三分钟不抢进入死信队列 管理端重新派单
- MySQL：关系型数据库存储
- Reids GEO：实时位置更新
- Reddison：对抢单进行锁
- xxl-job：对超时订单实行自动派单 用corn表达式
- 腾讯COS 与 位置服务

## 三、数据库
```sql
-- 创建万邦送货数据库
CREATE DATABASE IF NOT EXISTS `wanbang_delivery` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

USE `wanbang_delivery`;

-- 司机信息表
CREATE TABLE IF NOT EXISTS `driver_info` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '司机ID',
  `name` VARCHAR(50) NOT NULL COMMENT '司机姓名',
  `phone` VARCHAR(20) NOT NULL COMMENT '手机号',
  `avatar` VARCHAR(255) COMMENT '头像URL',
  `audit_status` TINYINT DEFAULT 0 COMMENT '审核状态(0=未审核,1=已通过,2=已拒绝)',
  `work_status` TINYINT DEFAULT 3 COMMENT '工作状态(1=空闲,2=忙碌,3=离线)',
  `openid` VARCHAR(100) COMMENT '微信OpenID',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uniq_phone` (`phone`),
  UNIQUE KEY `uniq_openid` (`openid`),
  KEY `idx_status` (`work_status`),
  KEY `idx_audit_status` (`audit_status`)
) ENGINE=InnoDB COMMENT='司机信息表';

-- 司机审核记录表
CREATE TABLE IF NOT EXISTS `driver_audit_log` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `driver_id` BIGINT NOT NULL COMMENT '司机ID',
  `audit_status` TINYINT NOT NULL COMMENT '审核状态(0=未审核,1=已通过,2=已拒绝)',
  `audit_remark` VARCHAR(255) COMMENT '审核备注',
  `auditor` VARCHAR(50) COMMENT '审核人',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMPCOMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_driver_id` (`driver_id`),
) ENGINE=InnoDB COMMENT='司机审核记录表';

-- 配送订单表
CREATE TABLE IF NOT EXISTS `delivery_order` (
  `id` BIGINT NOT NULL AUTO_INCREMENT ,
  `order_no` VARCHAR(30) NOT NULL COMMENT '订单编号',
  `driver_id` BIGINT COMMENT '司机ID',
  `customer_phone` VARCHAR(11) NOT NULL COMMENT '客户手机号',
  `delivery_address` VARCHAR NOT NULL COMMENT '派送地址',
  `delivery_status` TINYINT DEFAULT 1 COMMENT '配送状态(1=待派送,2=待接单,3=配送中,4=已完成,5=已取消)',
  `delivery_fee` DECIMAL(10,2) DEFAULT 0.00 COMMENT '配送费用',
  `delivery_note` VARCHAR(500) COMMENT '配送备注',
  `goods_weight` DECIMAL(10,2) COMMENT '货物重量(吨)',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uniq_delivery_no` (`order_no`),
  KEY `idx_order_no` (`order_no`),
  KEY `idx_driver_id` (`driver_id`),
  KEY `idx_status` (`delivery_status`),
) ENGINE=InnoDB COMMENT='配送订单表';
```

