# 万邦送货
## 一、项目概述
"万邦送货"是基于万邦仓储系统的物流配送解决方案，采用单体架构设计，集成订单派送、司机接单、实时位置追踪等功能，实现从仓库到客户的全流程物流配送管理。该系统基于Spring Boot框架，通过模块化设计实现高效、稳定的物流配送平台。

### 1.1 项目背景
万邦仓储系统目前已实现瓷砖库存管理和订单处理功能，但缺乏完整的物流配送环节。"万邦送货"项目将提供订单派送、司机接单、实时位置追踪等功能，弥补现有系统的不足，提升客户体验和运营效率。

### 1.2 项目目标
1. 构建基于单体架构的高效物流配送系统
2. 实现从订单生成到配送完成的全流程管理
3. 提供实时位置追踪和路线优化功能
4. 通过万邦后端系统对司机的注册，订单的派送，订单的监控，订单异常的处理进行管理。
5. 司机端只需要了解客户名称，客户手机号，目的地，货物吨位，与配送费。
6. 司机端第一次登陆小程序触发注册，需要输入姓名手机号，在点击注册之后，万邦后端系统会显示待审核司机，如果司机没被审核通过，小程序页面只会显示“待审核”，只有审核通过才能正常进入小程序。

## 二、系统架构设计
### 2.1 整体架构
采用Spring Boot单体应用架构，包含以下核心组件：
- Spring Boot：应用框架
- MyBatis Plus：ORM框架，简化数据库操作
- Redis：缓存和会话管理
- RabbitMQ：轻量级消息队列，实现异步通信
- MySQL：关系型数据库存储
- JWT：无状态认证
- WebSocket：实时位置更新

### 2.2 模块划分

| 模块名称         | 功能描述      |
| ------------ | --------- |
| auth         | 用户认证和授权管理 |
| driver       | 司机管理      |
| order        | 订单管理      |
| delivery     | 配送任务管理    |

## 三、数据库
```sql
-- 创建万邦送货数据库
CREATE DATABASE IF NOT EXISTS `wanbang_delivery` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

USE `wanbang_delivery`;

-- 司机信息表
CREATE TABLE IF NOT EXISTS `driver_info` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '司机ID',
  `driver_name` VARCHAR(50) NOT NULL COMMENT '司机姓名',
  `phone` VARCHAR(20) NOT NULL COMMENT '手机号',
  `avatar` VARCHAR(255) COMMENT '头像URL',
  `audit_status` TINYINT DEFAULT 0 COMMENT '审核状态(0=未审核,1=已通过,2=已拒绝)',
  `status` TINYINT DEFAULT 3 COMMENT '工作状态(1=空闲,2=忙碌,3=离线)',
  `openid` VARCHAR(100) COMMENT '微信OpenID',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uniq_phone` (`phone`),
  UNIQUE KEY `uniq_openid` (`openid`),
  KEY `idx_status` (`status`),
  KEY `idx_audit_status` (`audit_status`)
) ENGINE=InnoDB COMMENT='司机信息表';

-- 司机审核记录表
CREATE TABLE IF NOT EXISTS `driver_audit_log` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `driver_id` BIGINT NOT NULL COMMENT '司机ID',
  `audit_status` TINYINT NOT NULL COMMENT '审核状态(0=未审核,1=已通过,2=已拒绝)',
  `audit_remark` VARCHAR(255) COMMENT '审核备注',
  `auditor` VARCHAR(50) COMMENT '审核人',
  `audit_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '审核时间',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMPCOMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_driver_id` (`driver_id`),
  KEY `idx_audit_time` (`audit_time`)
) ENGINE=InnoDB COMMENT='司机审核记录表';

-- 配送订单表
CREATE TABLE IF NOT EXISTS `delivery_order` (
  `id` BIGINT NOT NULL AUTO_INCREMENT ,
  `order_no` VARCHAR(30) NOT NULL COMMENT '订单编号',
  `driver_id` BIGINT COMMENT '司机ID',
  `delivery_address` VARCHAR NOT NULL COMMENT '派送地址',
  `delivery_status` TINYINT DEFAULT 1 COMMENT '配送状态(1=待派送,2=待接单,3=配送中,4=已完成,5=已取消)',
  `delivery_fee` DECIMAL(10,2) DEFAULT 0.00 COMMENT '配送费用',
  `delivery_note` VARCHAR(500) COMMENT '配送备注',
  `goods_weight` DECIMAL(10,2) COMMENT '货物重量(吨)',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uniq_delivery_no` (`order_no`),
  KEY `idx_order_no` (`order_no`),
  KEY `idx_driver_id` (`driver_id`),
  KEY `idx_status` (`delivery_status`),
) ENGINE=InnoDB COMMENT='配送订单表';

-- 异常配送记录表
CREATE TABLE IF NOT EXISTS `delivery_exception` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `delivery_id` BIGINT NOT NULL COMMENT '配送单ID',
  `handler_id` BIGINT COMMENT '处理人ID',
  `handling_result` VARCHAR(500) COMMENT '处理结果',
  `handling_time` DATETIME COMMENT '处理时间',
  `status` TINYINT DEFAULT 1 COMMENT '状态(1=待处理,2=已处理)',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_delivery_id` (`delivery_id`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB COMMENT='异常配送记录表';

```
### 3.2 表结构说明
1. driver_info - 司机信息表
   - 存储司机基本信息（姓名、手机号、头像）
   - 包含审核状态字段，支持司机审核流程
   - 支持微信小程序登录

2. driver_audit_log - 司机审核记录表
   - 记录司机信息的审核历史
   - 存储审核人、审核时间和审核备注等信息

3. delivery_order - 配送订单表
   - 存储配送任务的核心信息
   - 关联原始订单数据，记录配送状态
   - 整合了路线信息和评价信息

4. delivery_exception - 异常配送记录表
   - 记录配送过程中的异常情况
   - 支持异常处理流程


## 四、接口设计

### 4.1 司机管理接口

| 接口路径 | 方法 | 描述 | 参数 |
|---------|-----|------|------|
| `/api/auth/login` | `POST` | 司机登录 | `LoginRequest` |
| `/api/auth/register` | `POST` | 司机注册 | `RegisterRequest{driverName, phone, avatar}` |
| `/api/auth/logout` | `POST` | 司机登出 | `-` |
| `/api/drivers` | `GET` | 获取司机列表 | `page`, `size`, `status`, `auditStatus` |
| `/api/drivers/{id}` | `GET` | 获取司机详情 | `id` |
| `/api/drivers/{id}/status` | `PUT` | 更新司机状态 | `id`, `status` |
| `/api/drivers/{id}/audit` | `PUT` | 审核司机信息 | `id`, `auditStatus`, `auditRemark` |

### 4.2 订单管理接口

| 接口路径 | 方法 | 描述 | 参数 |
|---------|-----|------|------|
| `/api/delivery/orders` | `GET` | 获取配送订单列表 | `page`, `size`, `status` |
| `/api/delivery/orders/dispatch` | `POST` | 派送订单 | `DispatchRequest` |
| `/api/delivery/orders/{id}` | `GET` | 获取配送详情 | `id` |
| `/api/delivery/orders/{id}/accept` | `POST` | 接单操作 | `id`, `driverId` |
| `/api/delivery/orders/{id}/status` | `PUT` | 更新配送状态 | `id`, `status` |
| `/api/delivery/exceptions` | `POST` | 报告配送异常 | `ExceptionRequest` |
| `/api/delivery/rating` | `POST` | 提交配送评价 | `RatingRequest` |


